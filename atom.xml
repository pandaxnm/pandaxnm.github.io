<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>小熊Blog</title>
  
  <subtitle>折腾不止</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://mokeee.com/"/>
  <updated>2019-07-10T07:15:06.126Z</updated>
  <id>https://mokeee.com/</id>
  
  <author>
    <name>chaojie.xiong</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用OpenSSL进行RSA签名和加密解密</title>
    <link href="https://mokeee.com/2019/07/09/open-ssl-rsa-sign-encrypt/"/>
    <id>https://mokeee.com/2019/07/09/open-ssl-rsa-sign-encrypt/</id>
    <published>2019-07-09T03:56:32.000Z</published>
    <updated>2019-07-10T07:15:06.126Z</updated>
    
    <content type="html"><![CDATA[<p>PHP7之后，mcrypt扩展就已经被弃用，我们可以使用OpenSSL拓展来代替。</p><p><img src="http://images.mokeee.com/blog/20190710151011.png" alt></p><p><strong>RSA加密算法是一种非对称加密算法，用法总结起来就是：公钥加密、私钥解密、私钥签名、公钥验签。</strong></p><a id="more"></a><p>签名与加密的作用：<br>1.签名是为了防止数据被篡改<br>2.加密是为了防止数据被泄露</p><h3 id="格式化公钥私钥"><a href="#格式化公钥私钥" class="headerlink" title="格式化公钥私钥"></a>格式化公钥私钥</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 格式化私钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $privateKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrivateKey</span><span class="params">($privateKey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $key = chunk_split($privateKey,<span class="number">64</span>,<span class="string">"\n"</span>);</span><br><span class="line">        $key = <span class="string">"-----BEGIN PRIVATE KEY-----\n"</span> . $key . <span class="string">"-----END PRIVATE KEY-----\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 格式化公钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $privateKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getPublicKey</span><span class="params">($publicKey)</span></span>&#123;</span><br><span class="line">        $key = chunk_split($publicKey,<span class="number">64</span>,<span class="string">"\n"</span>);</span><br><span class="line">        $key = <span class="string">"-----BEGIN PUBLIC KEY-----\n"</span> . $key . <span class="string">"-----END PUBLIC KEY-----\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $key;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="使用私钥签名"><a href="#使用私钥签名" class="headerlink" title="使用私钥签名"></a>使用私钥签名</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 签名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $params</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $privateKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sign</span><span class="params">($data, $privateKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $signature = <span class="string">''</span>;</span><br><span class="line">    openssl_sign($str, $signature, $privateKey, OPENSSL_ALGO_SHA1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> base64_encode($signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用公钥验签"><a href="#使用公钥验签" class="headerlink" title="使用公钥验签"></a>使用公钥验签</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $return</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $sign</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $publicKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($params, $sign, $publicKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $verify = openssl_verify($params, base64_decode($sign), $publicKey);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($verify != <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用公钥加密"><a href="#使用公钥加密" class="headerlink" title="使用公钥加密"></a>使用公钥加密</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rsa 公钥加密</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $data string 待加密的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $public_key 公钥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rsaPublicEncrypt</span><span class="params">($data, $publicKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = openssl_pkey_get_public($publicKey);</span><br><span class="line">    $encrypted = <span class="string">''</span>;</span><br><span class="line">    openssl_public_encrypt($data, $encrypted, $key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> base64_encode($encrypted);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用私钥解密"><a href="#使用私钥解密" class="headerlink" title="使用私钥解密"></a>使用私钥解密</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 私钥解密</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $encrypted 被加密的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $private_key 私钥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rsaPrivateDecrypt</span><span class="params">($encrypted, $private_key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    openssl_private_decrypt(base64_decode($encrypted),$decrypted,$private_key);</span><br><span class="line">    <span class="keyword">return</span> $decrypted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;PHP7之后，mcrypt扩展就已经被弃用，我们可以使用OpenSSL拓展来代替。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://images.mokeee.com/blog/20190710151011.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;RSA加密算法是一种非对称加密算法，用法总结起来就是：公钥加密、私钥解密、私钥签名、公钥验签。&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="https://mokeee.com/categories/PHP/"/>
    
    
      <category term="openSSL" scheme="https://mokeee.com/tags/openSSL/"/>
    
      <category term="RSA" scheme="https://mokeee.com/tags/RSA/"/>
    
  </entry>
  
  <entry>
    <title>Mac上使用Homebrew安装go</title>
    <link href="https://mokeee.com/2019/06/22/go-start/"/>
    <id>https://mokeee.com/2019/06/22/go-start/</id>
    <published>2019-06-22T15:46:47.000Z</published>
    <updated>2019-06-22T16:08:14.802Z</updated>
    
    <content type="html"><![CDATA[<p>最近准备学go，首先当然是安装开发环境了，贴一下安装过程。😬</p><blockquote><p>我的电脑是Mac，使用Homebrew来安装go。</p></blockquote><h3 id="安装go"><a href="#安装go" class="headerlink" title="安装go"></a>安装go</h3><p>使用Homebrew安装go</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install go</span><br></pre></td></tr></table></figure><p><img src="http://images.mokeee.com/blog/20190622234531.png" alt></p><p>安装完成，检查一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go version</span><br></pre></td></tr></table></figure><p><img src="http://images.mokeee.com/blog/20190623000634.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近准备学go，首先当然是安装开发环境了，贴一下安装过程。😬&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;我的电脑是Mac，使用Homebrew来安装go。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;安装go&quot;&gt;&lt;a href=&quot;#安装go&quot; class=&quot;head
      
    
    </summary>
    
      <category term="go" scheme="https://mokeee.com/categories/go/"/>
    
    
  </entry>
  
  <entry>
    <title>Mac上使用Homebrew搭建LNMP环境（简要版）</title>
    <link href="https://mokeee.com/2019/06/09/mac-homebrew-lnmp/"/>
    <id>https://mokeee.com/2019/06/09/mac-homebrew-lnmp/</id>
    <published>2019-06-09T09:18:39.000Z</published>
    <updated>2019-06-09T14:19:23.084Z</updated>
    
    <content type="html"><![CDATA[<p>最近发现自己这台Mac充电口已经糊掉了，并且使用的时候发热严重，于是向公司申请了一台。</p><a id="more"></a><p><img src="http://images.mokeee.com/blog/IMG_2250.JPG" alt></p><p><img src="http://images.mokeee.com/blog/UNADJUSTEDNONRAW_thumb_14b9.jpg" alt></p><p>结果给了我一台13寸的，而且键盘磨得漆都掉了。🤣</p><p>拿到手第一件事情就是咔咔重装系统，然后开始装开发环境。</p><h2 id="一、安装Homebrew"><a href="#一、安装Homebrew" class="headerlink" title="一、安装Homebrew"></a>一、安装Homebrew</h2><h3 id="1-安装comman-line"><a href="#1-安装comman-line" class="headerlink" title="1.安装comman line"></a>1.安装comman line</h3><blockquote><p><a href="https://brew.sh/" target="_blank" rel="noopener">Homebrew</a> 是一个包管理器，用于在Mac上安装一些OS X没有的UNIX工具</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br></pre></td></tr></table></figure><p>如果提示失败，请尝试手动安装<br>到这个地址 <a href="https://developer.apple.com/download/more/" target="_blank" rel="noopener">https://developer.apple.com/download/more/</a> 下载Command Line Tools，选择适合自己的版本。</p><p><img src="http://images.mokeee.com/blog/xcode_command_line.jpg" alt></p><h3 id="2-安装Homebrew"><a href="#2-安装Homebrew" class="headerlink" title="2.安装Homebrew"></a>2.安装Homebrew</h3><p>运行下面的命令即可安装Homebrew，安装开始前会有提示，同意即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br></pre></td></tr></table></figure><h2 id="二、安装Nginx"><a href="#二、安装Nginx" class="headerlink" title="二、安装Nginx"></a>二、安装Nginx</h2><p>运行下面的命令来安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nginx</span><br></pre></td></tr></table></figure><p>安装完成后将Nginx加入开机自启</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/opt/nginx/homebrew.mxcl.nginx.plist ~/Library/LaunchAgents/</span><br><span class="line">launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.nginx.plist</span><br></pre></td></tr></table></figure><p>给Nginx root权限 (路径根据版本而定)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown root:wheel /usr/<span class="built_in">local</span>/Cellar/nginx/1.6.0_1/bin/nginx</span><br><span class="line">sudo chmod u+s /usr/<span class="built_in">local</span>/Cellar/nginx/1.6.0_1/bin/nginx</span><br></pre></td></tr></table></figure><p>如果nginx启动报错：<code>nginx: [error] open() &quot;/usr/local/var/run/nginx.pid&quot; failed (2: No such file or directory)</code></p><p>执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -c /usr/<span class="built_in">local</span>/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><h2 id="三、安装MySql"><a href="#三、安装MySql" class="headerlink" title="三、安装MySql"></a>三、安装MySql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install mysql@5.7</span><br></pre></td></tr></table></figure><p>安装完成后开启mysql：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/opt/mysql@5.7/bin/mysql.server start</span><br></pre></td></tr></table></figure><p>然后设置密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/opt/mysql@5.7/bin/mysql_secure_installation</span><br></pre></td></tr></table></figure><p>根据提示操作即可</p><p>将MySql加入开机自启（路径根据版本而定）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/opt/mysql@5.7/homebrew.mxcl.mysql@5.7.plist  ~/Library/LaunchAgents/</span><br><span class="line">launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.mysql@5.7.plist</span><br></pre></td></tr></table></figure><h2 id="四、安装PHP"><a href="#四、安装PHP" class="headerlink" title="四、安装PHP"></a>四、安装PHP</h2><h3 id="1-安装PHP"><a href="#1-安装PHP" class="headerlink" title="1.安装PHP"></a>1.安装PHP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install php@7.1</span><br></pre></td></tr></table></figure><p>将php加入环境变量，运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/php@7.1/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/php@7.1/sbin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure><p>关闭终端，重新打开</p><h3 id="2-安装PHP扩展"><a href="#2-安装PHP扩展" class="headerlink" title="2.安装PHP扩展"></a>2.安装PHP扩展</h3><p>我们可以使用<code>pecl</code>命令来安装PHP拓展，如果你安装的PHP版本&gt;=7.1，pecl也一同安装好了。</p><blockquote><p>使用pecl安装拓展，只需执行命令即可，其他的会给你自动配置好，是不是敲方便的！</p></blockquote><p>安装Yaf扩展：<code>pecl install yaf</code><br>安装redis扩展： <code>pecl install install</code><br>安装debug：<code>pecl install xdebug</code>  </p><p>扩展安装完成后记得重启php-fpm</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew services restart php@7.1</span><br></pre></td></tr></table></figure><h2 id="五、安装redis"><a href="#五、安装redis" class="headerlink" title="五、安装redis"></a>五、安装redis</h2><p>同理，运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install redis</span><br></pre></td></tr></table></figure><h2 id="六、命令"><a href="#六、命令" class="headerlink" title="六、命令"></a>六、命令</h2><p>可能会用到的一些命令： </p><h3 id="1-搜索"><a href="#1-搜索" class="headerlink" title="1. 搜索"></a>1. 搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew search php</span><br></pre></td></tr></table></figure><p><img src="http://images.mokeee.com/blog/brew_search.jpg" alt></p><h3 id="2-安装卸载"><a href="#2-安装卸载" class="headerlink" title="2.安装卸载"></a>2.安装卸载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install\uninstall php@7.1</span><br></pre></td></tr></table></figure><h3 id="3-启动-重启-停止服务："><a href="#3-启动-重启-停止服务：" class="headerlink" title="3.启动\重启\停止服务："></a>3.启动\重启\停止服务：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew services start\restart\stop nginx\mysql@5.7\php@7.1</span><br></pre></td></tr></table></figure><h3 id="4-查看某个包的信息："><a href="#4-查看某个包的信息：" class="headerlink" title="4.查看某个包的信息："></a>4.查看某个包的信息：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew info nginx</span><br></pre></td></tr></table></figure><p>该命令会显示安装路径、配置文件等信息</p><p><img src="http://images.mokeee.com/blog/brew_info.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近发现自己这台Mac充电口已经糊掉了，并且使用的时候发热严重，于是向公司申请了一台。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Homebrew" scheme="https://mokeee.com/tags/Homebrew/"/>
    
      <category term="LNMP" scheme="https://mokeee.com/tags/LNMP/"/>
    
  </entry>
  
  <entry>
    <title>记一次使用PHP将word转为excel的经历</title>
    <link href="https://mokeee.com/2019/01/12/word-to-excel-use-php/"/>
    <id>https://mokeee.com/2019/01/12/word-to-excel-use-php/</id>
    <published>2019-01-12T08:24:06.000Z</published>
    <updated>2019-06-09T09:18:02.850Z</updated>
    
    <content type="html"><![CDATA[<p>昨天一位朋友找到我，说他手上有几千个word表格需要转换到一个excel文件里，他在网上也没有找到满足需求的软件，于是让我帮忙用程序实现。</p><a id="more"></a><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>需求如下图所示：每个文档文档中有一个或多个格式固定的表格，需要把每一个word表格转换为excel文件里的一行。</p><p>from:</p><p><img src="http://images.mokeee.com/2019-01-12-IMG_6264-20190112-024237-.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="IMG_6264-20190112-024237-"></p><p>to:</p><p><img src="http://images.mokeee.com/2019-01-12-IMG_6265-20190112-024237-.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="IMG_6265-20190112-024237-"></p><h3 id="寻找解决方案"><a href="#寻找解决方案" class="headerlink" title="寻找解决方案"></a>寻找解决方案</h3><p>我首先想到的是用PHP读取word文档，处理之后转成excel。</p><p>转成excel比较简单，使用PHP系统函数<code>fputcsv</code>就可以搞定，现在需要做的是读取到word文档里的内容。</p><p>紧接着我便去网上查找，看有没有PHP的扩展能够读取word文档。<br>在Github搜索到一个叫做 <a href="https://github.com/PHPOffice/PHPWord" target="_blank" rel="noopener">PHPWord</a> 的扩展，不过遗憾的是，这个扩展只能往word文档里写入内容，并不能读取。</p><p>我又想，能不能把word转成其他格式再读取。<br>于是我将word文档的后缀改成了<code>txt</code>,打开文件后内容如下图。</p><p>密密麻麻的一大堆，反正我是没能从中找到什么规律，于是放弃了这种方法。</p><p><img src="http://images.mokeee.com/2019-01-12-15472784366824.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="-w973"></p><p>接着我在word的另存为功能中，发现可以另存为其他格式。</p><p><img src="http://images.mokeee.com/2019-01-12-15472786250739.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="-w322"></p><p>于是选择保存为<code>htm</code>文件，随后在浏览器中打开转换好的文件，发现表格转换成了html中的table表格，非常标准。</p><p><img src="http://images.mokeee.com/2019-01-12-15472790353553.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="-w540"></p><p>这样我只需要遍历读取htm文件，获取其中的内容，再进行相应处理便能得到最终数据。</p><h3 id="进行处理"><a href="#进行处理" class="headerlink" title="进行处理"></a>进行处理</h3><h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><p> 首先我在网上下载了软件，将word文档批量转换为htm文件，并放在同一目录下</p><h5 id="读取文件内容"><a href="#读取文件内容" class="headerlink" title="读取文件内容"></a>读取文件内容</h5><p>我们事先将所有转换好的文件放在了同一目录下，所以只需要遍历该目录，并使用<code>file_get_contents()</code>函数就能获取到每个文件的内容。</p><h5 id="提取有用内容"><a href="#提取有用内容" class="headerlink" title="提取有用内容"></a>提取有用内容</h5><p>查看htm源代码能发现，每个word表格转换后变成了一个html表格，只需要先取到<code>&lt;table&gt;&lt;/table&gt;</code>标签里的内容，然后再按行分割，按列分割，便能得到我们想要的数据了。</p><p>附上简略代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成csv文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeExcel</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//写入文档头部</span></span><br><span class="line">    $fileName = <span class="string">'./data.csv'</span>;</span><br><span class="line">    file_put_contents($fileName,<span class="string">''</span>);</span><br><span class="line">    $handle = fopen($fileName, <span class="string">'w'</span>);</span><br><span class="line">    fwrite($handle, chr(<span class="number">0xEF</span>).chr(<span class="number">0xBB</span>).chr(<span class="number">0xBF</span>)); <span class="comment">// 写入BOM头，防止乱码</span></span><br><span class="line">    $titleArr = [<span class="string">'A'</span>  =&gt; <span class="string">'样品类型'</span>, <span class="string">'B'</span>  =&gt; <span class="string">'图幅编号'</span>];<span class="comment">//次数省略</span></span><br><span class="line">    fputcsv($handle, $titleArr);</span><br><span class="line">    <span class="keyword">return</span> $handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取文件夹下的所有文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scanFile</span><span class="params">($path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = [];</span><br><span class="line">    $files = scandir($path);</span><br><span class="line">    <span class="keyword">foreach</span> ($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($file != <span class="string">'.'</span> &amp;&amp; $file != <span class="string">'..'</span>) &#123;</span><br><span class="line">            $result[] = basename($file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//提取表格内容</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getContents</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $filesArr = scanFile(<span class="string">'./'</span>);</span><br><span class="line">    $handle = writeExcelHeader();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> ($filesName <span class="keyword">as</span> $k =&gt; $v)&#123;</span><br><span class="line">        <span class="comment">//读取文件内容</span></span><br><span class="line">        $text = file_get_contents($path . $v);</span><br><span class="line">        <span class="comment">//转换编码</span></span><br><span class="line">        $text = iconv(<span class="string">"gb2312"</span>, <span class="string">"utf-8//IGNORE"</span>,$text);</span><br><span class="line">        <span class="comment">//去除html标签多余属性</span></span><br><span class="line">        $text = preg_replace(<span class="string">"/&lt;([a-zA-Z]+)[^&gt;]*&gt;/"</span>,<span class="string">"&lt;\\1&gt;"</span>,$text);</span><br><span class="line">        <span class="comment">//提取表格内容</span></span><br><span class="line">        preg_match_all(<span class="string">"/&lt;table&gt;(.*?)&lt;\/table&gt;/is"</span>,$text,$matches);</span><br><span class="line">        <span class="comment">//处理表格内容</span></span><br><span class="line">        <span class="keyword">foreach</span> ($matches[<span class="number">1</span>] <span class="keyword">as</span> $match)&#123;</span><br><span class="line">            html2excel($match, $handle);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理表格内容</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span><span class="params">($content)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $res = [];</span><br><span class="line">    <span class="comment">//按行拆分</span></span><br><span class="line">    $trArr = explode(<span class="string">'&lt;tr&gt;'</span>, $content);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> ($trArr <span class="keyword">as</span> $k =&gt; $tr)&#123;</span><br><span class="line">        <span class="comment">//去除多余标签</span></span><br><span class="line">        $tr = str_replace(<span class="string">'&lt;/tr&gt;'</span>,<span class="string">''</span>, $tr);</span><br><span class="line">        <span class="comment">//按列拆分</span></span><br><span class="line">        $tdArr = explode(<span class="string">'&lt;td&gt;'</span>, $tr);</span><br><span class="line">        <span class="keyword">foreach</span> ($tdArr <span class="keyword">as</span> $kk =&gt; $td)&#123;</span><br><span class="line">            <span class="comment">//去除多余标签</span></span><br><span class="line">            $td = str_replace(<span class="string">'&lt;/td&gt;'</span>,<span class="string">''</span>, $td);</span><br><span class="line">            <span class="comment">//去除html标签 得到内容</span></span><br><span class="line">            $text = strip_tags($td);</span><br><span class="line">            $res[] = $text;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fputcsv($handel, $res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getContents();</span><br></pre></td></tr></table></figure><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>使用到的一些函数：</p><ol><li><code>iconv()</code> 编码转换</li><li><code>preg_replace()</code> 使用正则替换文本</li><li><code>preg_match_all()</code> 使用正则获取内容</li><li><code>strip_tags()</code> 去除文本中的html标签</li><li><code>str_replace()</code> 文本替换</li><li><code>fputcsv()</code> 将制定内容写入csv文件</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;昨天一位朋友找到我，说他手上有几千个word表格需要转换到一个excel文件里，他在网上也没有找到满足需求的软件，于是让我帮忙用程序实现。&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="https://mokeee.com/categories/PHP/"/>
    
    
      <category term="Safari" scheme="https://mokeee.com/tags/Safari/"/>
    
  </entry>
  
  <entry>
    <title>Safari【阻止跨网站追踪】遇到的问题</title>
    <link href="https://mokeee.com/2019/01/06/safari-cookie/"/>
    <id>https://mokeee.com/2019/01/06/safari-cookie/</id>
    <published>2019-01-06T07:30:59.000Z</published>
    <updated>2019-06-09T09:17:04.172Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h3 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h3><p>现有AB两个域名，分别使用在AB网站上。</p><ol><li>A向B发送一个jsonp跨域请求，进行用户登录操作</li><li>B收到请求并验证通过后会在自己的域名下写一个包含当前用户信息的cookie</li><li>当A网站再次向B网站发起获取用户信息的请求时，B网站会读取自己域名下的这个cookie来获取当前用户的信息并返回给A</li></ol><h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>在Windows PC上测试时一切正常，没有任何问题。<br>当使用Safari浏览器访问A网站时，用户登录操作正常，但在登录成功后，向B网站发起获取用户信息的请求时，总是提示获取不到。</p><p>在一番查找资料后发现，iOS系统上的Safari设置中默认开启了 <strong>阻止跨网站追踪</strong> 的功能，从而导致A网站向B网站发请求，B网站写cookie在B域名下的操作也无法完成…</p><p><img src="http://images.mokeee.com/2019-01-06-15467592058885.jpg" alt></p><p>**这个问题会出现在所有使用AppleWebkit内核的浏览器中。</p><blockquote><p>由于iOS系统限制，苹果只允许第三方浏览器使用AppleWebkit内核，所以按理iOS上的所有浏览器都会出现这个问题。</p></blockquote><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>严格来说也不算解决办法，算曲线救国吧…</p><p>当A向B发起登录请求并收到返回的数据后，A网站前端将B返回的数据存在A的cookie中，并在以后每次请求B时将cookie中的信息以参数形式发送给B。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h3&gt;&lt;p&gt;现有AB两个域名，分别使用在AB网站上。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;A向B发送一个jso
      
    
    </summary>
    
    
  </entry>
  
</feed>
