<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>小熊Blog</title>
  
  <subtitle>折腾不止</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://mokeee.com/"/>
  <updated>2019-07-20T14:15:16.514Z</updated>
  <id>https://mokeee.com/</id>
  
  <author>
    <name>chaojie.xiong</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Shell脚本学习笔记</title>
    <link href="https://mokeee.com/2019/07/14/shell-script-leaning/"/>
    <id>https://mokeee.com/2019/07/14/shell-script-leaning/</id>
    <published>2019-07-14T07:23:20.000Z</published>
    <updated>2019-07-20T14:15:16.514Z</updated>
    
    <content type="html"><![CDATA[<p>这是用来记录学习shell的文章，不断更新中。</p><a id="more"></a><blockquote><p>本文所写内容主要是根据网络教程和自我理解所得，如有错误之处，请指出。</p></blockquote><h1 id="解释器"><a href="#解释器" class="headerlink" title="解释器"></a>解释器</h1><p>一般shell脚本的第一行都是以 <code>#!/bin/sh</code> 开头，<code>#!</code> 标识用什么解释器来执行此脚本。</p><p>解释器的种类很多，比较常见的就是：</p><ul><li><code>/bin/sh</code></li><li><code>/bin/bash</code></li></ul><h1 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h1><p>在一行开头使用<code>#</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># author: 你的小可爱</span></span><br><span class="line"><span class="comment"># date: 2019-07-14</span></span><br></pre></td></tr></table></figure><p>shell中没有多行注释</p><h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><h2 id="命名规则"><a href="#命名规则" class="headerlink" title="命名规则"></a>命名规则</h2><ul><li>只能使用字母、数字、下划线，不能以数字开头</li><li>不能使用特殊符号</li><li>不能使用关键字</li></ul><p>变量名示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id</span><br><span class="line">USERNAME</span><br><span class="line">favorite</span><br><span class="line">favorite2</span><br><span class="line">_sex</span><br></pre></td></tr></table></figure><h2 id="使用变量"><a href="#使用变量" class="headerlink" title="使用变量"></a>使用变量</h2><h3 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">"你的小可爱"</span></span><br></pre></td></tr></table></figure><p>注意点：</p><ol><li>定义变量时，变量名不需要使用<code>$</code>符号</li><li>等号前后不能有空格</li></ol><h3 id="使用变量-1"><a href="#使用变量-1" class="headerlink" title="使用变量"></a>使用变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;name&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"我的名字是：<span class="variable">$&#123;name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">name=<span class="string">"大家的小可爱"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span></span><br></pre></td></tr></table></figure><p>注意点：</p><ol><li>定义变量时变量名前不需要加<code>$</code>，但使用时需要加<code>$</code>。</li><li>重新定义变量时，变量名前不需要加<code>$</code>,只在使用变量时才加。</li></ol><h1 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1><h2 id="单双引号"><a href="#单双引号" class="headerlink" title="单双引号"></a>单双引号</h2><p>在shell中字符串可以使用单引号、双引号，也可以不使用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str=<span class="string">'Hello World.'</span></span><br><span class="line">str2=<span class="string">"你好世界"</span></span><br><span class="line">str3=泥豪啊</span><br></pre></td></tr></table></figure><p>注意点：</p><ol><li>单引号中的内容会原样输出，单引号中的变量无效</li><li>单引号字串中不能出现单独一个的单引号（对单引号使用转义符后也不行）</li><li>双引号中可以使用变量和转义字符</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">age=18;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'my age is $&#123;age&#125;'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"my age is <span class="variable">$&#123;age&#125;</span> \nHow old are you?"</span></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">my age is $&#123;age&#125;</span><br><span class="line">my age is 18</span><br><span class="line">How old are you?</span><br></pre></td></tr></table></figure><h2 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h2><h3 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">"你的小可爱"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"你好，我是<span class="variable">$&#123;name&#125;</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"你好，我是"</span><span class="variable">$name</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"你好，我是"</span><span class="variable">$name</span><span class="string">"，哈哈"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'你好，我是'</span><span class="variable">$name</span><span class="string">'，哈哈'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># 你好，我是你的小可爱</span></span><br><span class="line"><span class="comment"># 你好，我是你的小可爱</span></span><br><span class="line"><span class="comment"># 你好，我是你的小可爱，哈哈</span></span><br><span class="line"><span class="comment"># 你好，我是你的小可爱，哈哈</span></span><br></pre></td></tr></table></figure><h3 id="字符串长度"><a href="#字符串长度" class="headerlink" title="字符串长度"></a>字符串长度</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str=<span class="string">"hello"</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;#str&#125;</span>;</span><br><span class="line"><span class="comment">#输出：5</span></span><br></pre></td></tr></table></figure><h3 id="字符串截取"><a href="#字符串截取" class="headerlink" title="字符串截取"></a>字符串截取</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">str=<span class="string">"abcdefg"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;str:1:3&#125;</span> </span><br><span class="line"><span class="comment"># 输出 bcd</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;str:0:4&#125;</span></span><br><span class="line"><span class="comment"># 输出 abcd</span></span><br></pre></td></tr></table></figure><h1 id="用户输入"><a href="#用户输入" class="headerlink" title="用户输入"></a>用户输入</h1><h2 id="执行脚本时传入"><a href="#执行脚本时传入" class="headerlink" title="执行脚本时传入"></a>执行脚本时传入</h2><ol><li>在执行脚本时可向脚本传入参数，参数之间用空格隔开，在脚本内使用<code>$n</code>来接收参数，n代表是第几个参数，如<code>$1</code>代表第一个参数。</li><li>如果参数内有空格，可以使用引号将参数括起来。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"执行的文件名：<span class="variable">$0</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"第一个参数为：<span class="variable">$1</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"第二个参数为：<span class="variable">$2</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"第二个参数为：<span class="variable">$3</span>"</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ ./test.sh 1 &apos;2 22&apos; &quot;3 33&quot;</span><br><span class="line">第一个参数为：1</span><br><span class="line">第二个参数为：2 22</span><br><span class="line">第二个参数为：3 33</span><br></pre></td></tr></table></figure><p>获取传入参数的个数，使用<code>$#</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"传入参数个数："</span><span class="variable">$#</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"传入参数个数：<span class="variable">$&#123;#&#125;</span>"</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ ./test.sh 1 &apos;2 22&apos; &quot;3 33&quot;</span><br><span class="line">传入参数个数：3</span><br><span class="line">传入参数个数：3</span><br></pre></td></tr></table></figure><h2 id="运行脚本时输入"><a href="#运行脚本时输入" class="headerlink" title="运行脚本时输入"></a>运行脚本时输入</h2><p>使用<code>read</code>在程序运行时获取用户输入的参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"Please enter your name:"</span></span><br><span class="line"><span class="built_in">read</span> name</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hello <span class="variable">$name</span>"</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ ./test.sh</span><br><span class="line">Please enter your name:</span><br><span class="line">熊小帅</span><br><span class="line">Hello 熊小帅</span><br></pre></td></tr></table></figure><p>使用<code>-p</code>直接指定一个提示语句</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span> -p <span class="string">"Please enter your name:"</span> name</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hello <span class="variable">$name</span>"</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ ./test.sh</span><br><span class="line">Please enter your name:熊大帅</span><br><span class="line">Hello 熊大帅</span><br></pre></td></tr></table></figure><p>使用<code>-t</code>进行倒计时，用户需要在指定时间(秒)内完成输入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">read</span> -t 5 -p <span class="string">"Please enter your name in 5 seconds:"</span> name</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Hello <span class="variable">$name</span>"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"timeout"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ ./test.sh</span><br><span class="line">Please enter your name in 5 seconds:</span><br><span class="line">timeout</span><br></pre></td></tr></table></figure><p>使用<code>-s</code>隐藏输入内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span> -s -p <span class="string">"Please enter your password:"</span> <span class="built_in">pwd</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"I got it! Your password is: <span class="variable">$pwd</span>"</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ ./test.sh</span><br><span class="line">Please enter your password:</span><br><span class="line">I got it! Your password is: 123456</span><br></pre></td></tr></table></figure><h1 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h1><p>shell中的运算符包括：</p><ul><li>算数运算符</li><li>关系运算符</li><li>布尔运算符</li><li>字符串运算符</li><li>文件测试运算符</li></ul><p>在Linux的shell中，变量的值的类型默认是字符串，不能直接进行数值运算。<br>但是可以通过其他命令来实现，如expr。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> `expr 1 + 2`</span><br><span class="line"><span class="comment"># 输出：3</span></span><br></pre></td></tr></table></figure><p>注意：</p><ol><li>表达式需要用反引号<code>``</code>括起来</li><li>表达式和运算符之间要用空格隔开，如<code>1 + 2</code>不能写成<code>1+2</code>，<code>=</code> 赋值时，前后无空格</li></ol><h2 id="算数运算符"><a href="#算数运算符" class="headerlink" title="算数运算符"></a>算数运算符</h2><table><thead><tr><th align="center">运算符</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">+</td><td align="center">加</td></tr><tr><td align="center">-</td><td align="center">减</td></tr><tr><td align="center">*</td><td align="center">乘</td></tr><tr><td align="center">/</td><td align="center">除</td></tr><tr><td align="center">%</td><td align="center">取余</td></tr><tr><td align="center">=</td><td align="center">赋值</td></tr><tr><td align="center">==</td><td align="center">相等</td></tr><tr><td align="center">!=</td><td align="center">不等</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line"><span class="built_in">echo</span> `expr <span class="variable">$a</span> + <span class="variable">$b</span>`</span><br><span class="line"><span class="built_in">echo</span> `expr <span class="variable">$a</span> - <span class="variable">$b</span>`</span><br><span class="line"><span class="built_in">echo</span> `expr <span class="variable">$a</span> \* <span class="variable">$b</span>`</span><br><span class="line"><span class="built_in">echo</span> `expr <span class="variable">$b</span> / <span class="variable">$a</span>`</span><br><span class="line"><span class="built_in">echo</span> `expr <span class="variable">$b</span> % <span class="variable">$a</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> == <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a等于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span>  [ <span class="variable">$a</span> != <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a不等于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">-1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">0</span><br><span class="line">a不等于b</span><br></pre></td></tr></table></figure><p>注意：</p><ol><li><code>[]</code>代表一个表达式，<code>[]</code>中的内容要与两侧的符号使用空格隔开，<br>如<code>[ $a + $b ]</code>，不能写成<code>[$a+$b]</code></li><li>乘号<code>*</code>前边必须加反斜杠<code>\</code></li><li>在MAC上，expr语法可以写成 <code>$((表达式))</code>，亲测表达式和运算符之间可以不加空格，<br><code>$(($a+$b))</code>和<code>$(($a + $b))</code>都可以；乘法写成<code>$(($a*$b))</code>，不需要加<code>\</code></li></ol><p>MAC shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line"><span class="built_in">echo</span> $((<span class="variable">$a</span> + <span class="variable">$b</span>))</span><br><span class="line"><span class="built_in">echo</span> $((<span class="variable">$a</span>-<span class="variable">$b</span>))</span><br><span class="line"><span class="built_in">echo</span> $((<span class="variable">$a</span>*<span class="variable">$b</span>))</span><br><span class="line"><span class="built_in">echo</span> $((<span class="variable">$b</span>/<span class="variable">$a</span>))</span><br><span class="line"><span class="built_in">echo</span> $((<span class="variable">$b</span>%<span class="variable">$a</span>))</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> == <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a等于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span>  [ <span class="variable">$a</span> != <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a不等于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">-1</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">0</span><br><span class="line">a不等于b</span><br></pre></td></tr></table></figure><h2 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a>关系运算符</h2><table><thead><tr><th align="center">运算符</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">-eq</td><td align="center">相等</td></tr><tr><td align="center">-ne</td><td align="center">不等</td></tr><tr><td align="center">-gt</td><td align="center">大于</td></tr><tr><td align="center">-lt</td><td align="center">小于</td></tr><tr><td align="center">-ge</td><td align="center">大于等于</td></tr><tr><td align="center">-le</td><td align="center">小于等于</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -eq <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a等于b"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a不等于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -ne <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a不等于b"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a等于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -gt <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a大于b"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a不大于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -lt <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a小于b"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a不小于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -ge <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a大于等于b"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a小于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -le <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a小于等于b"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a大于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜ sh test.sh</span><br><span class="line">a不等于b</span><br><span class="line">a不等于b</span><br><span class="line">a不大于b</span><br><span class="line">a小于b</span><br><span class="line">a小于b</span><br><span class="line">a小于等于b</span><br></pre></td></tr></table></figure><h2 id="布尔运算符"><a href="#布尔运算符" class="headerlink" title="布尔运算符"></a>布尔运算符</h2><table><thead><tr><th align="center">运算符</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">!</td><td align="center">非</td></tr><tr><td align="center">-o</td><td align="center">或</td></tr><tr><td align="center">-a</td><td align="center">与</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">a=1</span><br><span class="line">b=20</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> != <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a不等于b"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a等于b"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -gt 2 -o <span class="variable">$b</span> -gt 10 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a大于2或b大于10"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a小于等于2并且b小于等于10"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -gt 2 -a <span class="variable">$b</span> -gt 10 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a大于2并且b大于10"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a小于等于2或者b小于等于10"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜ sh test.sh</span><br><span class="line">a不等于b</span><br><span class="line">a大于2或b大于10</span><br><span class="line">a小于等于2或者b小于等于10</span><br></pre></td></tr></table></figure><h2 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h2><table><thead><tr><th align="center">运算符</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">&amp;&amp;</td><td align="center">逻辑and</td></tr><tr><td align="center">||</td><td align="center">逻辑or</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">a=1</span><br><span class="line">b=20</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$a</span> -lt 2 &amp;&amp; <span class="variable">$b</span> -gt 10 ]]</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a小于2并且b大于10"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a大于等于2或者b小于等于10"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$a</span> -lt 2 || <span class="variable">$b</span> -gt 10 ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a小于2或者b大于10"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"a大于等于2并且b小于等于10"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜ sh test.sh</span><br><span class="line">a小于2并且b大于10</span><br><span class="line">a小于2或者b大于10</span><br></pre></td></tr></table></figure><blockquote><p><code>[[  ]]</code> 是什么？</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这是用来记录学习shell的文章，不断更新中。&lt;/p&gt;
    
    </summary>
    
      <category term="Shell" scheme="https://mokeee.com/categories/Shell/"/>
    
    
  </entry>
  
  <entry>
    <title>使用Redis锁来处理并发</title>
    <link href="https://mokeee.com/2019/07/10/redis-lock/"/>
    <id>https://mokeee.com/2019/07/10/redis-lock/</id>
    <published>2019-07-10T15:05:49.000Z</published>
    <updated>2019-07-15T12:57:30.419Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><p><strong>问题：</strong></p><p>最近在和第三方对接支付，今天看日志发现他们的回调竟然并发了，有点方。<br>虽然每次回调的时候，都会查数据库检查这个订单的状态，然后对进行相应处理。但同一个订单如果遇到并发，第一个请求还没写入数据库，第二个请求就来了，这种情况就会导致错误。</p><p><img src="http://images.mokeee.com/blog/20190710230813.png" alt></p><p><strong>解决办法：</strong></p><p>使用Redis锁，每个请求到达时先加锁，如果加锁成功才会执行后面的业务逻辑，执行结束后释放锁。</p><p>比如：同一个订单并发的情况，我们可以使用订单号作为Redis的键名，每次请求前都会先加锁，如果加锁失败，说明该订单正在进行处理，并把这个请求挡回去；如果加锁成功，则执行后面的业务逻辑，并在完成后解锁。</p><p>我想到的是使用Redis的set命令，2.6.12之后版本，Redis set指令支持了nx、ex模式，并支持原子化地设置过期时间。</p><blockquote><p>NX ：只在键不存在时，才对键进行设置操作。 SET key value NX 效果等同于 SETNX key value 。</p></blockquote><p><img src="http://images.mokeee.com/blog/20190710232324.png" alt></p><p><strong>PHP实现</strong></p><ol><li>加锁<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加锁</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $orderId 订单ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool|int 加锁成功返回唯一锁ID，加锁失败返回false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">addLock</span><span class="params">($orderId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!$orderId)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $key = <span class="keyword">self</span>::REDIS_LOCK_NAME . $orderId;</span><br><span class="line">    $client = BaseRedis::getClient();</span><br><span class="line">    <span class="comment">//生成锁ID 自行实现</span></span><br><span class="line">    $lockId = uniqid();</span><br><span class="line">    <span class="comment">//需要设置一个到期时间，避免死锁</span></span><br><span class="line">    $res = $client-&gt;set($key, $lockId, [<span class="string">'nx'</span>, <span class="string">'ex'</span> =&gt; <span class="keyword">self</span>::REDIS_LOCK_EXPIRE_TIME]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $res ? $lockId : $res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>2.解锁</p><p>解锁时用lockId进行比较，如果相等则删除锁。</p><blockquote><p>watch: 监视一个(或多个) key ，如果在事务执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断。</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解锁</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $orderId 订单ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $lockId 锁唯一ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">unLock</span><span class="params">($orderId, $lockId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!$orderId)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $key = <span class="keyword">self</span>::REDIS_LOCK_NAME . $orderId;</span><br><span class="line">    $client = BaseRedis::getClient();</span><br><span class="line"></span><br><span class="line">    $client-&gt;watch($key);</span><br><span class="line">    <span class="keyword">if</span> ($lockId == $client-&gt;get($key)) &#123;</span><br><span class="line">        <span class="comment">// 以 MULTI 开始一个事务，然后将多个命令入队到事务中， 最后由 EXEC 命令触发事务，一并执行事务中的所有命令</span></span><br><span class="line">        $client-&gt;multi()-&gt;del($key)-&gt;exec();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $client-&gt;unwatch();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>目前对分布式缓存还不太了解，后续学习。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;&lt;strong&gt;问题：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;最近在和第三方对接支付，今天看日志发现他们的回调竟然并发了，有点方。&lt;br&gt;虽然每次回调的时候，都会查数据库检查这个订单的状态，然后对进行相应处理。但同一个订单如果遇到并发，第一个请
      
    
    </summary>
    
      <category term="Redis" scheme="https://mokeee.com/categories/Redis/"/>
    
    
      <category term="并发" scheme="https://mokeee.com/tags/%E5%B9%B6%E5%8F%91/"/>
    
      <category term="Redis" scheme="https://mokeee.com/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>使用OpenSSL进行RSA签名和加密解密</title>
    <link href="https://mokeee.com/2019/07/09/open-ssl-rsa-sign-encrypt/"/>
    <id>https://mokeee.com/2019/07/09/open-ssl-rsa-sign-encrypt/</id>
    <published>2019-07-09T03:56:32.000Z</published>
    <updated>2019-07-10T15:28:24.146Z</updated>
    
    <content type="html"><![CDATA[<p>PHP7之后，mcrypt扩展就已经被弃用，我们可以使用OpenSSL拓展来代替。</p><a id="more"></a><p><img src="http://images.mokeee.com/blog/20190710151011.png" alt></p><p><strong>RSA加密算法是一种非对称加密算法，用法总结起来就是：公钥加密、私钥解密、私钥签名、公钥验签。</strong></p><p>签名与加密的作用：<br>1.签名是为了防止数据被篡改<br>2.加密是为了防止数据被泄露</p><h3 id="格式化公钥私钥"><a href="#格式化公钥私钥" class="headerlink" title="格式化公钥私钥"></a>格式化公钥私钥</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 格式化私钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $privateKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrivateKey</span><span class="params">($privateKey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $key = chunk_split($privateKey,<span class="number">64</span>,<span class="string">"\n"</span>);</span><br><span class="line">        $key = <span class="string">"-----BEGIN PRIVATE KEY-----\n"</span> . $key . <span class="string">"-----END PRIVATE KEY-----\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 格式化公钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $privateKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getPublicKey</span><span class="params">($publicKey)</span></span>&#123;</span><br><span class="line">        $key = chunk_split($publicKey,<span class="number">64</span>,<span class="string">"\n"</span>);</span><br><span class="line">        $key = <span class="string">"-----BEGIN PUBLIC KEY-----\n"</span> . $key . <span class="string">"-----END PUBLIC KEY-----\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $key;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="使用私钥签名"><a href="#使用私钥签名" class="headerlink" title="使用私钥签名"></a>使用私钥签名</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 签名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $params</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $privateKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sign</span><span class="params">($data, $privateKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $signature = <span class="string">''</span>;</span><br><span class="line">    openssl_sign($str, $signature, $privateKey, OPENSSL_ALGO_SHA1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> base64_encode($signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用公钥验签"><a href="#使用公钥验签" class="headerlink" title="使用公钥验签"></a>使用公钥验签</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $return</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $sign</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $publicKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($params, $sign, $publicKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $verify = openssl_verify($params, base64_decode($sign), $publicKey);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($verify != <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用公钥加密"><a href="#使用公钥加密" class="headerlink" title="使用公钥加密"></a>使用公钥加密</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rsa 公钥加密</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $data string 待加密的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $public_key 公钥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rsaPublicEncrypt</span><span class="params">($data, $publicKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = openssl_pkey_get_public($publicKey);</span><br><span class="line">    $encrypted = <span class="string">''</span>;</span><br><span class="line">    openssl_public_encrypt($data, $encrypted, $key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> base64_encode($encrypted);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用私钥解密"><a href="#使用私钥解密" class="headerlink" title="使用私钥解密"></a>使用私钥解密</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 私钥解密</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $encrypted 被加密的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $private_key 私钥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rsaPrivateDecrypt</span><span class="params">($encrypted, $private_key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    openssl_private_decrypt(base64_decode($encrypted),$decrypted,$private_key);</span><br><span class="line">    <span class="keyword">return</span> $decrypted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;PHP7之后，mcrypt扩展就已经被弃用，我们可以使用OpenSSL拓展来代替。&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="https://mokeee.com/categories/PHP/"/>
    
    
      <category term="openSSL" scheme="https://mokeee.com/tags/openSSL/"/>
    
      <category term="RSA" scheme="https://mokeee.com/tags/RSA/"/>
    
  </entry>
  
  <entry>
    <title>Mac上使用Homebrew搭建LNMP环境（简要版）</title>
    <link href="https://mokeee.com/2019/06/09/mac-homebrew-lnmp/"/>
    <id>https://mokeee.com/2019/06/09/mac-homebrew-lnmp/</id>
    <published>2019-06-09T09:18:39.000Z</published>
    <updated>2019-06-09T14:19:23.084Z</updated>
    
    <content type="html"><![CDATA[<p>最近发现自己这台Mac充电口已经糊掉了，并且使用的时候发热严重，于是向公司申请了一台。</p><a id="more"></a><p><img src="http://images.mokeee.com/blog/IMG_2250.JPG" alt></p><p><img src="http://images.mokeee.com/blog/UNADJUSTEDNONRAW_thumb_14b9.jpg" alt></p><p>结果给了我一台13寸的，而且键盘磨得漆都掉了。🤣</p><p>拿到手第一件事情就是咔咔重装系统，然后开始装开发环境。</p><h2 id="一、安装Homebrew"><a href="#一、安装Homebrew" class="headerlink" title="一、安装Homebrew"></a>一、安装Homebrew</h2><h3 id="1-安装comman-line"><a href="#1-安装comman-line" class="headerlink" title="1.安装comman line"></a>1.安装comman line</h3><blockquote><p><a href="https://brew.sh/" target="_blank" rel="noopener">Homebrew</a> 是一个包管理器，用于在Mac上安装一些OS X没有的UNIX工具</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br></pre></td></tr></table></figure><p>如果提示失败，请尝试手动安装<br>到这个地址 <a href="https://developer.apple.com/download/more/" target="_blank" rel="noopener">https://developer.apple.com/download/more/</a> 下载Command Line Tools，选择适合自己的版本。</p><p><img src="http://images.mokeee.com/blog/xcode_command_line.jpg" alt></p><h3 id="2-安装Homebrew"><a href="#2-安装Homebrew" class="headerlink" title="2.安装Homebrew"></a>2.安装Homebrew</h3><p>运行下面的命令即可安装Homebrew，安装开始前会有提示，同意即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br></pre></td></tr></table></figure><h2 id="二、安装Nginx"><a href="#二、安装Nginx" class="headerlink" title="二、安装Nginx"></a>二、安装Nginx</h2><p>运行下面的命令来安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nginx</span><br></pre></td></tr></table></figure><p>安装完成后将Nginx加入开机自启</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/opt/nginx/homebrew.mxcl.nginx.plist ~/Library/LaunchAgents/</span><br><span class="line">launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.nginx.plist</span><br></pre></td></tr></table></figure><p>给Nginx root权限 (路径根据版本而定)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chown root:wheel /usr/<span class="built_in">local</span>/Cellar/nginx/1.6.0_1/bin/nginx</span><br><span class="line">sudo chmod u+s /usr/<span class="built_in">local</span>/Cellar/nginx/1.6.0_1/bin/nginx</span><br></pre></td></tr></table></figure><p>如果nginx启动报错：<code>nginx: [error] open() &quot;/usr/local/var/run/nginx.pid&quot; failed (2: No such file or directory)</code></p><p>执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -c /usr/<span class="built_in">local</span>/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><h2 id="三、安装MySql"><a href="#三、安装MySql" class="headerlink" title="三、安装MySql"></a>三、安装MySql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install mysql@5.7</span><br></pre></td></tr></table></figure><p>安装完成后开启mysql：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/opt/mysql@5.7/bin/mysql.server start</span><br></pre></td></tr></table></figure><p>然后设置密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/opt/mysql@5.7/bin/mysql_secure_installation</span><br></pre></td></tr></table></figure><p>根据提示操作即可</p><p>将MySql加入开机自启（路径根据版本而定）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/opt/mysql@5.7/homebrew.mxcl.mysql@5.7.plist  ~/Library/LaunchAgents/</span><br><span class="line">launchctl load -w ~/Library/LaunchAgents/homebrew.mxcl.mysql@5.7.plist</span><br></pre></td></tr></table></figure><h2 id="四、安装PHP"><a href="#四、安装PHP" class="headerlink" title="四、安装PHP"></a>四、安装PHP</h2><h3 id="1-安装PHP"><a href="#1-安装PHP" class="headerlink" title="1.安装PHP"></a>1.安装PHP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install php@7.1</span><br></pre></td></tr></table></figure><p>将php加入环境变量，运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/php@7.1/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/php@7.1/sbin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br></pre></td></tr></table></figure><p>关闭终端，重新打开</p><h3 id="2-安装PHP扩展"><a href="#2-安装PHP扩展" class="headerlink" title="2.安装PHP扩展"></a>2.安装PHP扩展</h3><p>我们可以使用<code>pecl</code>命令来安装PHP拓展，如果你安装的PHP版本&gt;=7.1，pecl也一同安装好了。</p><blockquote><p>使用pecl安装拓展，只需执行命令即可，其他的会给你自动配置好，是不是敲方便的！</p></blockquote><p>安装Yaf扩展：<code>pecl install yaf</code><br>安装redis扩展： <code>pecl install install</code><br>安装debug：<code>pecl install xdebug</code>  </p><p>扩展安装完成后记得重启php-fpm</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew services restart php@7.1</span><br></pre></td></tr></table></figure><h2 id="五、安装redis"><a href="#五、安装redis" class="headerlink" title="五、安装redis"></a>五、安装redis</h2><p>同理，运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install redis</span><br></pre></td></tr></table></figure><h2 id="六、命令"><a href="#六、命令" class="headerlink" title="六、命令"></a>六、命令</h2><p>可能会用到的一些命令： </p><h3 id="1-搜索"><a href="#1-搜索" class="headerlink" title="1. 搜索"></a>1. 搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew search php</span><br></pre></td></tr></table></figure><p><img src="http://images.mokeee.com/blog/brew_search.jpg" alt></p><h3 id="2-安装卸载"><a href="#2-安装卸载" class="headerlink" title="2.安装卸载"></a>2.安装卸载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install\uninstall php@7.1</span><br></pre></td></tr></table></figure><h3 id="3-启动-重启-停止服务："><a href="#3-启动-重启-停止服务：" class="headerlink" title="3.启动\重启\停止服务："></a>3.启动\重启\停止服务：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew services start\restart\stop nginx\mysql@5.7\php@7.1</span><br></pre></td></tr></table></figure><h3 id="4-查看某个包的信息："><a href="#4-查看某个包的信息：" class="headerlink" title="4.查看某个包的信息："></a>4.查看某个包的信息：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew info nginx</span><br></pre></td></tr></table></figure><p>该命令会显示安装路径、配置文件等信息</p><p><img src="http://images.mokeee.com/blog/brew_info.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近发现自己这台Mac充电口已经糊掉了，并且使用的时候发热严重，于是向公司申请了一台。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Homebrew" scheme="https://mokeee.com/tags/Homebrew/"/>
    
      <category term="LNMP" scheme="https://mokeee.com/tags/LNMP/"/>
    
  </entry>
  
  <entry>
    <title>记一次使用PHP将word转为excel的经历</title>
    <link href="https://mokeee.com/2019/01/12/word-to-excel-use-php/"/>
    <id>https://mokeee.com/2019/01/12/word-to-excel-use-php/</id>
    <published>2019-01-12T08:24:06.000Z</published>
    <updated>2019-06-09T09:18:02.850Z</updated>
    
    <content type="html"><![CDATA[<p>昨天一位朋友找到我，说他手上有几千个word表格需要转换到一个excel文件里，他在网上也没有找到满足需求的软件，于是让我帮忙用程序实现。</p><a id="more"></a><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>需求如下图所示：每个文档文档中有一个或多个格式固定的表格，需要把每一个word表格转换为excel文件里的一行。</p><p>from:</p><p><img src="http://images.mokeee.com/2019-01-12-IMG_6264-20190112-024237-.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="IMG_6264-20190112-024237-"></p><p>to:</p><p><img src="http://images.mokeee.com/2019-01-12-IMG_6265-20190112-024237-.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="IMG_6265-20190112-024237-"></p><h3 id="寻找解决方案"><a href="#寻找解决方案" class="headerlink" title="寻找解决方案"></a>寻找解决方案</h3><p>我首先想到的是用PHP读取word文档，处理之后转成excel。</p><p>转成excel比较简单，使用PHP系统函数<code>fputcsv</code>就可以搞定，现在需要做的是读取到word文档里的内容。</p><p>紧接着我便去网上查找，看有没有PHP的扩展能够读取word文档。<br>在Github搜索到一个叫做 <a href="https://github.com/PHPOffice/PHPWord" target="_blank" rel="noopener">PHPWord</a> 的扩展，不过遗憾的是，这个扩展只能往word文档里写入内容，并不能读取。</p><p>我又想，能不能把word转成其他格式再读取。<br>于是我将word文档的后缀改成了<code>txt</code>,打开文件后内容如下图。</p><p>密密麻麻的一大堆，反正我是没能从中找到什么规律，于是放弃了这种方法。</p><p><img src="http://images.mokeee.com/2019-01-12-15472784366824.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="-w973"></p><p>接着我在word的另存为功能中，发现可以另存为其他格式。</p><p><img src="http://images.mokeee.com/2019-01-12-15472786250739.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="-w322"></p><p>于是选择保存为<code>htm</code>文件，随后在浏览器中打开转换好的文件，发现表格转换成了html中的table表格，非常标准。</p><p><img src="http://images.mokeee.com/2019-01-12-15472790353553.jpg?imageView2/3/w/1000/h/1000/interlace/1/q/100" alt="-w540"></p><p>这样我只需要遍历读取htm文件，获取其中的内容，再进行相应处理便能得到最终数据。</p><h3 id="进行处理"><a href="#进行处理" class="headerlink" title="进行处理"></a>进行处理</h3><h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><p> 首先我在网上下载了软件，将word文档批量转换为htm文件，并放在同一目录下</p><h5 id="读取文件内容"><a href="#读取文件内容" class="headerlink" title="读取文件内容"></a>读取文件内容</h5><p>我们事先将所有转换好的文件放在了同一目录下，所以只需要遍历该目录，并使用<code>file_get_contents()</code>函数就能获取到每个文件的内容。</p><h5 id="提取有用内容"><a href="#提取有用内容" class="headerlink" title="提取有用内容"></a>提取有用内容</h5><p>查看htm源代码能发现，每个word表格转换后变成了一个html表格，只需要先取到<code>&lt;table&gt;&lt;/table&gt;</code>标签里的内容，然后再按行分割，按列分割，便能得到我们想要的数据了。</p><p>附上简略代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成csv文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeExcel</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//写入文档头部</span></span><br><span class="line">    $fileName = <span class="string">'./data.csv'</span>;</span><br><span class="line">    file_put_contents($fileName,<span class="string">''</span>);</span><br><span class="line">    $handle = fopen($fileName, <span class="string">'w'</span>);</span><br><span class="line">    fwrite($handle, chr(<span class="number">0xEF</span>).chr(<span class="number">0xBB</span>).chr(<span class="number">0xBF</span>)); <span class="comment">// 写入BOM头，防止乱码</span></span><br><span class="line">    $titleArr = [<span class="string">'A'</span>  =&gt; <span class="string">'样品类型'</span>, <span class="string">'B'</span>  =&gt; <span class="string">'图幅编号'</span>];<span class="comment">//次数省略</span></span><br><span class="line">    fputcsv($handle, $titleArr);</span><br><span class="line">    <span class="keyword">return</span> $handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取文件夹下的所有文件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scanFile</span><span class="params">($path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $result = [];</span><br><span class="line">    $files = scandir($path);</span><br><span class="line">    <span class="keyword">foreach</span> ($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($file != <span class="string">'.'</span> &amp;&amp; $file != <span class="string">'..'</span>) &#123;</span><br><span class="line">            $result[] = basename($file);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//提取表格内容</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getContents</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $filesArr = scanFile(<span class="string">'./'</span>);</span><br><span class="line">    $handle = writeExcelHeader();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> ($filesName <span class="keyword">as</span> $k =&gt; $v)&#123;</span><br><span class="line">        <span class="comment">//读取文件内容</span></span><br><span class="line">        $text = file_get_contents($path . $v);</span><br><span class="line">        <span class="comment">//转换编码</span></span><br><span class="line">        $text = iconv(<span class="string">"gb2312"</span>, <span class="string">"utf-8//IGNORE"</span>,$text);</span><br><span class="line">        <span class="comment">//去除html标签多余属性</span></span><br><span class="line">        $text = preg_replace(<span class="string">"/&lt;([a-zA-Z]+)[^&gt;]*&gt;/"</span>,<span class="string">"&lt;\\1&gt;"</span>,$text);</span><br><span class="line">        <span class="comment">//提取表格内容</span></span><br><span class="line">        preg_match_all(<span class="string">"/&lt;table&gt;(.*?)&lt;\/table&gt;/is"</span>,$text,$matches);</span><br><span class="line">        <span class="comment">//处理表格内容</span></span><br><span class="line">        <span class="keyword">foreach</span> ($matches[<span class="number">1</span>] <span class="keyword">as</span> $match)&#123;</span><br><span class="line">            html2excel($match, $handle);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理表格内容</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span><span class="params">($content)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $res = [];</span><br><span class="line">    <span class="comment">//按行拆分</span></span><br><span class="line">    $trArr = explode(<span class="string">'&lt;tr&gt;'</span>, $content);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> ($trArr <span class="keyword">as</span> $k =&gt; $tr)&#123;</span><br><span class="line">        <span class="comment">//去除多余标签</span></span><br><span class="line">        $tr = str_replace(<span class="string">'&lt;/tr&gt;'</span>,<span class="string">''</span>, $tr);</span><br><span class="line">        <span class="comment">//按列拆分</span></span><br><span class="line">        $tdArr = explode(<span class="string">'&lt;td&gt;'</span>, $tr);</span><br><span class="line">        <span class="keyword">foreach</span> ($tdArr <span class="keyword">as</span> $kk =&gt; $td)&#123;</span><br><span class="line">            <span class="comment">//去除多余标签</span></span><br><span class="line">            $td = str_replace(<span class="string">'&lt;/td&gt;'</span>,<span class="string">''</span>, $td);</span><br><span class="line">            <span class="comment">//去除html标签 得到内容</span></span><br><span class="line">            $text = strip_tags($td);</span><br><span class="line">            $res[] = $text;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fputcsv($handel, $res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getContents();</span><br></pre></td></tr></table></figure><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>使用到的一些函数：</p><ol><li><code>iconv()</code> 编码转换</li><li><code>preg_replace()</code> 使用正则替换文本</li><li><code>preg_match_all()</code> 使用正则获取内容</li><li><code>strip_tags()</code> 去除文本中的html标签</li><li><code>str_replace()</code> 文本替换</li><li><code>fputcsv()</code> 将制定内容写入csv文件</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;昨天一位朋友找到我，说他手上有几千个word表格需要转换到一个excel文件里，他在网上也没有找到满足需求的软件，于是让我帮忙用程序实现。&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="https://mokeee.com/categories/PHP/"/>
    
    
      <category term="Safari" scheme="https://mokeee.com/tags/Safari/"/>
    
  </entry>
  
  <entry>
    <title>Safari【阻止跨网站追踪】遇到的问题</title>
    <link href="https://mokeee.com/2019/01/06/safari-cookie/"/>
    <id>https://mokeee.com/2019/01/06/safari-cookie/</id>
    <published>2019-01-06T07:30:59.000Z</published>
    <updated>2019-06-09T09:17:04.172Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h3 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h3><p>现有AB两个域名，分别使用在AB网站上。</p><ol><li>A向B发送一个jsonp跨域请求，进行用户登录操作</li><li>B收到请求并验证通过后会在自己的域名下写一个包含当前用户信息的cookie</li><li>当A网站再次向B网站发起获取用户信息的请求时，B网站会读取自己域名下的这个cookie来获取当前用户的信息并返回给A</li></ol><h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>在Windows PC上测试时一切正常，没有任何问题。<br>当使用Safari浏览器访问A网站时，用户登录操作正常，但在登录成功后，向B网站发起获取用户信息的请求时，总是提示获取不到。</p><p>在一番查找资料后发现，iOS系统上的Safari设置中默认开启了 <strong>阻止跨网站追踪</strong> 的功能，从而导致A网站向B网站发请求，B网站写cookie在B域名下的操作也无法完成…</p><p><img src="http://images.mokeee.com/2019-01-06-15467592058885.jpg" alt></p><p>**这个问题会出现在所有使用AppleWebkit内核的浏览器中。</p><blockquote><p>由于iOS系统限制，苹果只允许第三方浏览器使用AppleWebkit内核，所以按理iOS上的所有浏览器都会出现这个问题。</p></blockquote><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>严格来说也不算解决办法，算曲线救国吧…</p><p>当A向B发起登录请求并收到返回的数据后，A网站前端将B返回的数据存在A的cookie中，并在以后每次请求B时将cookie中的信息以参数形式发送给B。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;需求描述&quot;&gt;&lt;a href=&quot;#需求描述&quot; class=&quot;headerlink&quot; title=&quot;需求描述&quot;&gt;&lt;/a&gt;需求描述&lt;/h3&gt;&lt;p&gt;现有AB两个域名，分别使用在AB网站上。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;A向B发送一个jso
      
    
    </summary>
    
    
  </entry>
  
</feed>
